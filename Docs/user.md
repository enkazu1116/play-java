# ユーザーマスタ設計
## 機能一覧
- ユーザー登録・編集・削除・検索
- ユーザー一覧
- ユーザー名重複チェック

## ユーザーマスタ
user_id        : UUID
user_name      : VARCHAR(50)
password       : VARCHAR(100)
role           : SMALLINT
delete_flag    : BOOLEAN
create_user    : VARCHAR(50)
create_date    : TIMESTAMP
update_user    : VARCHAR(50)
update_date    : TIMESTAMP

### 制約・インデックス
- 主キー: user_id
- ユニークキー: user_name（一意性制約）
- インデックス: user_name, role（検索で主に使用される項目）

### バリデーション要件
#### 必須項目
- user_name: 必須（NOT NULL）
- password: 必須（NOT NULL）
- role: 必須（NOT NULL）

#### 文字数制限
- user_name: 3文字以上50文字以内（VARCHAR(50)）
- password: 8文字以上100文字以内（VARCHAR(100)）

#### フォーマット制約
- user_name: 
  - 3文字以上50文字以内
  - システム内で一意であること（重複不可、データベース制約により保証）
  - 更新時: 既存のユーザー名と重複しないこと（自分自身を除く）
- password: 
  - 8文字以上100文字以内
  - 任意の文字列を許可
- role: 
  - 0（一般ユーザー）または1（管理者）のいずれか
  - デフォルト値: 0（一般ユーザー）

#### 一意性制約
- user_name: データベースレベルでユニークキー制約あり
  - システム内で一意であること
  - 更新時: 既存のユーザー名と重複しないこと（自分自身を除く）

## 機能詳細
### ユーザー登録・編集・削除
#### ユーザー登録
**ユースケース**
1. 新規ユーザーを登録する
   - スタッフが新規ユーザーアカウントを作成する。

**ユーザーID**
- ユーザーIDはシステムが自動生成を行う（ユーザー入力不可）
- 形式: UUID（UUIDv7形式）
- 生成タイミング: ユーザー登録時に自動生成

**ロール**
- roleの値と意味:
  - 0: 一般ユーザー
  - 1: 管理者
- デフォルト値: 0（一般ユーザー）
- 作成時は自動的に一般ユーザーに設定される

**バリデーション**
- user_name: 必須、3文字以上50文字以内、システム内で一意であること
- password: 必須、8文字以上100文字以内
- role: 必須、0（一般ユーザー）または1（管理者）のいずれか（デフォルト: 0）

**エラーハンドリング**
- ユーザー名重複チェック: 既に同じuser_nameが存在する場合、エラーを返す
- バリデーションエラー: 必須項目未入力、文字数超過、フォーマット不正の場合、エラーを返す

#### ユーザー編集
**ユースケース**
1. ユーザーから要望を受けて、スタッフが編集を行う。
2. パスワードを変更する。

**編集可能項目**
- user_name: 編集可能（既存のユーザー名と重複しないこと、自分自身を除く）
- password: 編集可能
- role: 編集可能（0または1）

**バリデーション**
- user_id: 必須、ユーザーマスタに存在するユーザーIDであること
- user_name: 必須、3文字以上50文字以内、既存のユーザー名と重複しないこと（自分自身を除く）
- password: 必須、8文字以上100文字以内
- role: 必須、0（一般ユーザー）または1（管理者）のいずれか

**エラーハンドリング**
- 存在チェック: 指定されたuser_idが存在しない場合、エラーを返す
- ユーザー名重複チェック: 既に同じuser_nameが存在する場合（自分自身を除く）、エラーを返す
- バリデーションエラー: 必須項目未入力、文字数超過、フォーマット不正の場合、エラーを返す

#### ユーザー削除
**ユースケース**
1. スタッフが削除を行う。

**削除仕様**
- 論理削除を実施（delete_flagをtrueに更新）
- 物理削除は行わず、ユーザーに関連する情報（作成・更新履歴など）は保持
- 論理削除後は通常の検索では取得されない（delete_flagを明示的に指定した場合のみ取得可能）

**エラーハンドリング**
- 存在チェック: 指定されたuser_idが存在しない場合、エラーを返す
- 既に削除済み: 既に論理削除されている場合もエラーを返す（冪等性のため）

#### ユーザー検索
**ユースケース**
1. スタッフが検索を行う。
2. ユーザー一覧を表示する。

**検索条件**
以下の条件を任意に組み合わせて検索可能（複数条件はAND条件で結合）。

| 項目 | 検索方法 | 説明 |
|------|----------|------|
| user_name | 部分一致 | ユーザー名による部分一致検索（LIKE検索） |

**検索仕様**
- 部分一致検索: 前後方一致（例: "yamada"で検索 → "yamada_taro"、"suzuki_yamada"がヒット）
- 削除フラグのデフォルト動作: 
  - 検索条件にdelete_flagが未指定の場合、削除済み（delete_flag=true）のレコードは除外
  - delete_flagを明示的に指定した場合のみ、削除済みレコードも検索対象に含める

**ページング・ソート**
- ページング: 対応（ページ番号、ページサイズを指定可能）
  - ページ番号: 1から開始
  - デフォルトページサイズ: 10件
- ソート: 対応（ソート対象カラム、ソート順を指定可能）
  - ソート対象カラム: userName, role, createDate, updateDate
  - ソート順: asc（昇順）/ desc（降順）
  - デフォルトソート: createDate desc（作成日時降順）

#### ユーザー検索（シンプル版）
**ユースケース**
1. ページング不要でユーザー情報を取得する。

**検索仕様**
- ユーザー名による部分一致検索
- ページングなし、全件取得

#### ユーザー名重複チェック
**ユースケース**
1. ユーザー登録・編集時に、ユーザー名の重複をチェックする。

**チェック仕様**
- 指定されたuser_nameが既に存在するかチェック
- 更新時は自分自身を除外してチェック（excludeUserIdを指定可能）
- 戻り値: true（重複あり）/ false（重複なし）

**エラーハンドリング**
- エラーは返さず、重複の有無をbooleanで返す

### ユーザー一覧
**ユースケース**
ダッシュボード画面にユーザーの一覧を表示するために必要な情報を取得する。
