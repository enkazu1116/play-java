# 注文ドメイン設計

## 機能一覧
- 注文作成（店舗購入・取り寄せ注文・カスタマイズオーダー）
- 注文確定
- 注文一覧
- 注文詳細
- 注文キャンセル

## 注文トランザクション
order_id          : UUID
customer_id       : UUID
order_date        : DATETIME
status            : SMALLINT
delete_flag       : BOOLEAN
create_user       : UUID
create_date       : DATETIME
update_user       : UUID
update_date       : DATETIME

### 制約・インデックス
- 主キー: order_id
- 外部キー: customer_id（顧客マスタ参照）
- インデックス: customer_id, order_date（検索で主に使用される項目）

### 注文明細トランザクション
order_item_id     : UUID
order_id          : UUID
product_id        : UUID
quantity          : INT
unit_price        : INT
create_date       : DATETIME
update_date       : DATETIME

### 制約・インデックス
- 主キー: order_item_id
- 外部キー: order_id（注文トランザクション参照）、product_id（商品マスタ参照）
- インデックス: order_id

### ステータス定義
注文のステータスはSMALLINT型で管理する。以下の値を想定：
- 0: 仮注文（下書き状態）
- 1: 注文確定（確定済み）
- 2: 取り寄せ中（取り寄せ注文の場合）
- 3: カスタマイズ中（カスタマイズオーダーの場合）
- 4: 配送中
- 5: 配送完了
- 6: キャンセル済み

## 機能詳細

### 注文作成

#### ユースケース1: 店舗で顧客から購入があったとき
**概要**
店舗に来店した顧客が商品を購入する際の注文処理。

**処理フロー**
1. 顧客の特定
   - 既存顧客の場合: 顧客検索で顧客を選択
   - 新規顧客の場合: 顧客登録処理を先に実行
2. 注文情報の入力
   - 注文商品の選択（商品ID、数量）
   - 在庫確認（商品の在庫数量を確認）
3. 注文の作成
   - 注文トランザクション（t_order）の作成
     - order_id: 自動生成（UUID）
     - customer_id: 選択または登録した顧客ID
     - order_date: 現在日時
     - status: 1（注文確定）
   - 注文明細トランザクション（t_order_item）の作成
     - 各商品ごとに明細レコードを作成
     - product_id: 選択した商品ID
     - quantity: 注文数量
     - unit_price: 注文時点の商品単価（商品マスタから取得）
4. 在庫の減算
   - 注文確定後、該当商品の在庫数量を減算
   - 在庫不足の場合はエラーを返す

**バリデーション**
- customer_id: 必須、顧客マスタに存在すること
- 注文明細: 1件以上必須
- product_id: 必須、商品マスタに存在すること
- quantity: 必須、1以上の整数
- 在庫数量: 注文数量が在庫数量以下であること

**エラーハンドリング**
- 顧客が存在しない場合: エラーを返す
- 商品が存在しない場合: エラーを返す
- 在庫不足の場合: エラーを返す（在庫数量 < 注文数量）
- 注文明細が0件の場合: エラーを返す

#### ユースケース2: 取り寄せ注文
**概要**
店舗に在庫がない商品を仕入先から取り寄せる注文処理。

**処理フロー**
1. 顧客の特定
   - 既存顧客の場合: 顧客検索で顧客を選択
   - 新規顧客の場合: 顧客登録処理を先に実行
2. 注文情報の入力
   - 取り寄せ商品の選択（商品ID、数量）
   - 在庫確認（在庫がない、または不足していることを確認）
3. 注文の作成
   - 注文トランザクション（t_order）の作成
     - order_id: 自動生成（UUID）
     - customer_id: 選択または登録した顧客ID
     - order_date: 現在日時
     - status: 2（取り寄せ中）
   - 注文明細トランザクション（t_order_item）の作成
     - 各商品ごとに明細レコードを作成
     - product_id: 選択した商品ID
     - quantity: 注文数量
     - unit_price: 注文時点の商品単価（商品マスタから取得）
4. 在庫の減算（取り寄せ商品が到着した時点で実行）
   - 取り寄せ商品が到着したら、注文ステータスを更新し、在庫を減算
   - 取り寄せ中は在庫を減算しない

**バリデーション**
- customer_id: 必須、顧客マスタに存在すること
- 注文明細: 1件以上必須
- product_id: 必須、商品マスタに存在すること
- quantity: 必須、1以上の整数

**エラーハンドリング**
- 顧客が存在しない場合: エラーを返す
- 商品が存在しない場合: エラーを返す
- 注文明細が0件の場合: エラーを返す

**取り寄せ商品の到着処理**
- 取り寄せ商品が到着したら、注文ステータスを「注文確定（1）」に更新
- その後、在庫を減算する処理を実行

#### ユースケース3: カスタマイズオーダー
**概要**
顧客の要望に応じて商品をカスタマイズする注文処理。

**処理フロー**
1. 顧客の特定
   - 既存顧客の場合: 顧客検索で顧客を選択
   - 新規顧客の場合: 顧客登録処理を先に実行
2. 注文情報の入力
   - カスタマイズ対象商品の選択（商品ID、数量）
   - カスタマイズ内容の記録（備考欄など、将来的に拡張可能）
3. 注文の作成
   - 注文トランザクション（t_order）の作成
     - order_id: 自動生成（UUID）
     - customer_id: 選択または登録した顧客ID
     - order_date: 現在日時
     - status: 3（カスタマイズ中）
   - 注文明細トランザクション（t_order_item）の作成
     - 各商品ごとに明細レコードを作成
     - product_id: 選択した商品ID
     - quantity: 注文数量
     - unit_price: 注文時点の商品単価（商品マスタから取得、カスタマイズ料金は将来的に拡張可能）
4. 在庫の減算（カスタマイズ完了時点で実行）
   - カスタマイズが完了したら、注文ステータスを更新し、在庫を減算
   - カスタマイズ中は在庫を減算しない

**バリデーション**
- customer_id: 必須、顧客マスタに存在すること
- 注文明細: 1件以上必須
- product_id: 必須、商品マスタに存在すること
- quantity: 必須、1以上の整数

**エラーハンドリング**
- 顧客が存在しない場合: エラーを返す
- 商品が存在しない場合: エラーを返す
- 注文明細が0件の場合: エラーを返す

**カスタマイズ完了処理**
- カスタマイズが完了したら、注文ステータスを「注文確定（1）」に更新
- その後、在庫を減算する処理を実行

### 注文確定

**ユースケース**
1. 取り寄せ注文の商品が到着したとき
2. カスタマイズオーダーのカスタマイズが完了したとき
3. 仮注文（下書き状態）を確定するとき

**処理フロー**
1. 注文の存在確認
   - 指定されたorder_idの注文が存在することを確認
2. ステータスの更新
   - 注文ステータスを「注文確定（1）」に更新
3. 在庫の減算
   - 注文確定時点で在庫を減算
   - 各注文明細の商品について、在庫数量から注文数量を減算
   - 在庫不足の場合はエラーを返す

**バリデーション**
- order_id: 必須、注文トランザクションに存在すること
- 注文ステータス: 確定可能なステータスであること（仮注文、取り寄せ中、カスタマイズ中）

**エラーハンドリング**
- 注文が存在しない場合: エラーを返す
- 既に確定済みの場合: エラーを返す（冪等性のため）
- キャンセル済みの場合: エラーを返す
- 在庫不足の場合: エラーを返す

### 注文一覧

**ユースケース**
1. スタッフが注文一覧を確認する
2. 特定の顧客の注文履歴を確認する
3. 特定の期間の注文を確認する

**検索条件**
以下の条件を任意に組み合わせて検索可能（複数条件はAND条件で結合）。

| 項目 | 検索方法 | 説明 |
|------|----------|------|
| order_id | 完全一致 | 注文IDによる完全一致検索 |
| customer_id | 完全一致 | 顧客IDによる完全一致検索 |
| order_date | 範囲指定 | 注文日時の範囲指定（開始日時～終了日時） |
| status | 完全一致 | ステータスによる完全一致検索 |
| delete_flag | 完全一致 | 削除フラグによるフィルタ（true/false/null）<br>未指定時は削除済みを除外（falseのみ） |

**検索仕様**
- 複数条件の組み合わせ: AND条件（すべての条件を満たすレコードを取得）
- 削除フラグのデフォルト動作: 
  - 検索条件にdelete_flagが未指定の場合、削除済み（delete_flag=true）のレコードは除外
  - delete_flagを明示的に指定した場合のみ、削除済みレコードも検索対象に含める

**ページング・ソート**
- ページング: 対応（ページ番号、ページサイズを指定可能）
  - ページ番号: 1から開始
  - デフォルトページサイズ: 10件
- ソート: 対応（ソート対象カラム、ソート順を指定可能）
  - ソート対象カラム: order_id, customer_id, order_date, status, create_date, update_date
  - ソート順: asc（昇順）/ desc（降順）
  - デフォルトソート: order_date desc（注文日時降順）

### 注文詳細

**ユースケース**
1. スタッフが特定の注文の詳細情報を確認する
2. 注文のステータスや明細を確認する

**取得情報**
- 注文トランザクション情報
  - order_id, customer_id, order_date, status, delete_flag, create_user, create_date, update_user, update_date
- 注文明細トランザクション情報（複数件）
  - order_item_id, order_id, product_id, quantity, unit_price, create_date, update_date
- 関連情報（必要に応じて）
  - 顧客情報（customer_idから取得）
  - 商品情報（product_idから取得）

**バリデーション**
- order_id: 必須、注文トランザクションに存在すること

**エラーハンドリング**
- 注文が存在しない場合: エラーを返す

### 注文キャンセル

**ユースケース**
1. 顧客からキャンセル依頼があったとき
2. 在庫不足などで注文をキャンセルするとき

**処理フロー**
1. 注文の存在確認
   - 指定されたorder_idの注文が存在することを確認
2. キャンセル可能性の確認
   - 注文ステータスがキャンセル可能な状態であることを確認
   - 配送完了済みの場合はキャンセル不可
3. ステータスの更新
   - 注文ステータスを「キャンセル済み（6）」に更新
4. 在庫の戻し（必要に応じて）
   - 既に在庫を減算している場合（注文確定済みの場合）、在庫を戻す
   - 取り寄せ中やカスタマイズ中の場合は在庫を戻さない（まだ減算していないため）

**バリデーション**
- order_id: 必須、注文トランザクションに存在すること
- 注文ステータス: キャンセル可能なステータスであること（配送完了以外）

**エラーハンドリング**
- 注文が存在しない場合: エラーを返す
- 既にキャンセル済みの場合: エラーを返す（冪等性のため）
- 配送完了済みの場合: エラーを返す（キャンセル不可）

## 在庫管理との連携

### 在庫減算のタイミング
- **店舗購入（status=1）**: 注文確定と同時に在庫を減算
- **取り寄せ注文（status=2）**: 取り寄せ商品が到着し、ステータスを「注文確定（1）」に更新した時点で在庫を減算
- **カスタマイズオーダー（status=3）**: カスタマイズが完了し、ステータスを「注文確定（1）」に更新した時点で在庫を減算

### 在庫戻しのタイミング
- 注文キャンセル時、既に在庫を減算している場合（status=1の状態でキャンセル）のみ在庫を戻す
- 取り寄せ中やカスタマイズ中の注文をキャンセルした場合は、在庫を戻さない（まだ減算していないため）
