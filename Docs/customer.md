# 顧客マスタ設計
## 機能一覧
- 顧客登録・編集・削除・検索
- 顧客一覧

## 顧客マスタ
customer_id       : UUID
customer_number   : VARCHAR(10)
customer_name     : VARCHAR(50)
address           : VARCHAR(100)
phone_number      : VARCHAR(20)
email             : VARCHAR(50)
delete_flag       : BOOLEAN
create_user       : UUID
create_date       : DATETIME
update_user       : UUID
update_date       : DATETIME

### 制約・インデックス
- 主キー: customer_id
- ユニークキー: customer_number（一意性制約）
- インデックス: customer_name, address, phone_number, email（検索で主に使用される項目）

### バリデーション要件
#### 必須項目
- customer_name: 必須（NOT NULL）

#### 文字数制限
- customer_number: 最大10文字（VARCHAR(10)）
- customer_name: 最大50文字（VARCHAR(50)）
- address: 最大100文字（VARCHAR(100)）
- phone_number: 最大20文字（VARCHAR(20)）
- email: 最大50文字（VARCHAR(50)）

#### フォーマット制約
- customer_number: 
  - 自動採番（ユーザー入力不可）
  - 形式: 4文字のランダム英字（大文字） + 6桁のランダム数字
    - 例: ABCD123456, WXYZ789012, MNOP345678
  - 最大10文字（VARCHAR(10)）
  - システム内で一意であること（重複不可、データベース制約により保証）
  - 重複チェック: 生成した番号が既に存在する場合、再生成を試行（最大試行回数を設定）
- email: 
  - メールアドレスの形式（例: user@example.com）
  - 任意項目（NULL可）
- phone_number: 
  - 電話番号形式（任意の形式を許可）
  - 任意項目（NULL可）

#### 一意性制約
- customer_number: データベースレベルでユニークキー制約あり
  - ランダム生成により重複の可能性は低いが、重複時は再生成を試行
  - 更新時: 顧客番号は変更不可（自動採番項目のため編集不可）

## 機能詳細
### 顧客登録・編集・削除
#### 顧客登録
**ユースケース**
1. 商品購入時に顧客登録を行う
   - 商品購入処理の前に、顧客登録処理を行う。
   - 既存顧客の場合は顧客検索で選択し、新規顧客の場合のみ登録を行う。
2. 顧客登録のみを行う
   - スタッフが顧客情報を事前に登録する。

**顧客番号**
- 顧客番号はシステムが自動採番を行う（ユーザー入力不可）
- 形式: 4文字のランダム英字（大文字） + 6桁のランダム数字
  - 例: ABCD123456, WXYZ789012, MNOP345678
- 生成ルール:
  - 先頭4文字: ランダムな英字（A-Z、大文字のみ）
  - 後ろ6桁: ランダムな数字（0-9）
  - 合計10文字
- 採番タイミング: 顧客登録時に自動生成
- 重複チェック: 生成した番号が既に存在する場合、再生成を試行（最大試行回数を設定）
- 一意性: データベースレベルでユニークキー制約により保証


**バリデーション**
- customer_number: 自動採番のためバリデーション不要（システムが生成）
- customer_name: 必須、50文字以内
- address: 任意、100文字以内
- phone_number: 任意、20文字以内
- email: 任意、50文字以内、メールアドレス形式

**エラーハンドリング**
- 自動採番エラー: 重複チェックで最大試行回数を超えた場合、エラーを返す（実装上は考慮が必要）
- バリデーションエラー: 必須項目未入力、文字数超過、フォーマット不正の場合、エラーを返す

#### 顧客編集
**ユースケース**
1. 顧客から要望を受けて、スタッフが編集を行う。

**編集可能項目**
- customer_number: 編集不可（自動採番項目のため変更不可）
- customer_name: 編集可能
- address: 編集可能
- phone_number: 編集可能
- email: 編集可能

**バリデーション**
- customer_name: 必須、50文字以内
- address: 任意、100文字以内
- phone_number: 任意、20文字以内
- email: 任意、50文字以内、メールアドレス形式

**エラーハンドリング**
- 存在チェック: 指定されたcustomer_idが存在しない場合、エラーを返す
- バリデーションエラー: 必須項目未入力、文字数超過、フォーマット不正の場合、エラーを返す

#### 顧客削除
**ユースケース**
1. スタッフが削除を行う。

**削除仕様**
- 論理削除を実施（delete_flagをtrueに更新）
- 物理削除は行わず、顧客に関連する情報（注文履歴など）は保持
- 論理削除後は通常の検索では取得されない（delete_flagを明示的に指定した場合のみ取得可能）

**エラーハンドリング**
- 存在チェック: 指定されたcustomer_idが存在しない場合、エラーを返す
- 既に削除済み: 既に論理削除されている場合もエラーを返す（冪等性のため）

#### 顧客検索
**ユースケース**
1. スタッフが検索を行う。
2. 商品購入時に既存顧客を検索・選択する。

**検索条件**
以下の条件を任意に組み合わせて検索可能（複数条件はAND条件で結合）。

| 項目 | 検索方法 | 説明 |
|------|----------|------|
| customer_number | 完全一致 | 顧客番号による完全一致検索 |
| customer_name | 部分一致 | 顧客名による部分一致検索（LIKE検索） |
| address | 部分一致 | 住所による部分一致検索（LIKE検索） |
| phone_number | 完全一致 | 電話番号による完全一致検索 |
| email | 完全一致 | メールアドレスによる完全一致検索 |
| delete_flag | 完全一致 | 削除フラグによるフィルタ（true/false/null）<br>未指定時は削除済みを除外（falseのみ） |

**検索仕様**
- 複数条件の組み合わせ: AND条件（すべての条件を満たすレコードを取得）
- 部分一致検索: 前後方一致（例: "山田"で検索 → "山田太郎"、"佐藤山田"がヒット）
- 削除フラグのデフォルト動作: 
  - 検索条件にdelete_flagが未指定の場合、削除済み（delete_flag=true）のレコードは除外
  - delete_flagを明示的に指定した場合のみ、削除済みレコードも検索対象に含める

**ページング・ソート**
- ページング: 対応（ページ番号、ページサイズを指定可能）
  - ページ番号: 1から開始
  - デフォルトページサイズ: 10件
- ソート: 対応（ソート対象カラム、ソート順を指定可能）
  - ソート対象カラム: customer_number, customer_name, create_date, update_date
  - ソート順: asc（昇順）/ desc（降順）
  - デフォルトソート: update_date desc（更新日時降順）

### 顧客一覧
**ユースケース**
ダッシュボード画面に顧客の一覧を表示するために必要な情報を取得する。