# 在庫管理マスタ設計
## 機能一覧
- 在庫登録・編集・削除・検索
- 在庫一覧
- 在庫照会（商品ID指定）

## 在庫マスタ
stock_id       : UUID
product_id     : UUID
quantity       : INT
status         : SMALLINT
delete_flag    : BOOLEAN
create_user    : UUID
create_date    : TIMESTAMP
update_user    : UUID
update_date    : TIMESTAMP

### 制約・インデックス
- 主キー: stock_id
- ユニークキー: product_id（一意性制約、1商品につき1在庫レコード）
- 外部キー: product_id → m_product(product_id)
- インデックス: product_id（検索で主に使用される項目）

### バリデーション要件
#### 必須項目
- product_id: 必須（NOT NULL）
- quantity: 必須（NOT NULL、デフォルト値: 0）
- status: 必須（NOT NULL）

#### 数値制約
- quantity: 0以上の整数（負の値は不可）
- status: 0（在庫あり）、1（在庫なし）、2（発注済み）のいずれか

#### 一意性制約
- product_id: データベースレベルでユニークキー制約あり
  - 1商品につき1在庫レコードのみ存在可能
  - 既存の在庫レコードがある場合、新規登録は不可（更新APIを使用）

#### 外部キー制約
- product_id: 商品マスタ（m_product）に存在する商品IDである必要がある

## 機能詳細
### 在庫登録・編集・削除
#### 在庫登録
**ユースケース**
1. 新規商品の在庫を登録する
   - 商品マスタに登録された商品に対して、在庫情報を登録する。
2. 商品登録と同時に在庫を登録する
   - 商品登録処理の後に、在庫登録処理を行う。

**在庫ID**
- 在庫IDはシステムが自動生成を行う（ユーザー入力不可）
- 形式: UUID（UUIDv7形式）
- 生成タイミング: 在庫登録時に自動生成

**在庫ステータス**
- statusの値と意味:
  - 0: 在庫あり
  - 1: 在庫なし
  - 2: 発注済み
- 自動設定ルール:
  - statusが未指定の場合、quantity > 0 なら 0（在庫あり）、quantity = 0 なら 1（在庫なし）を自動設定
  - statusが明示的に指定された場合、その値を使用（0-2の範囲内である必要がある）

**バリデーション**
- product_id: 必須、商品マスタに存在する商品IDであること
- quantity: 必須、0以上の整数
- status: 必須、0（在庫あり）、1（在庫なし）、2（発注済み）のいずれか
- 一意性チェック: 同じproduct_idの在庫レコードが既に存在する場合、エラーを返す

**エラーハンドリング**
- 商品マスタ存在チェック: 指定されたproduct_idが商品マスタに存在しない場合、エラーを返す
- 一意性エラー: 同じproduct_idの在庫レコードが既に存在する場合、エラーを返す（更新APIを使用するよう案内）
- バリデーションエラー: 必須項目未入力、数値範囲外、ステータス値不正の場合、エラーを返す

#### 在庫編集
**ユースケース**
1. 在庫数量を更新する
   - 入荷・出荷により在庫数量を変更する。
2. 在庫ステータスを更新する
   - 在庫状況に応じてステータスを変更する。

**編集可能項目**
- product_id: 編集可能（商品マスタに存在する商品IDである必要がある）
- quantity: 編集可能
- status: 編集可能

**在庫ステータスの自動更新**
- statusが未指定の場合、quantity > 0 なら 0（在庫あり）、quantity = 0 なら 1（在庫なし）を自動設定
- statusが明示的に指定された場合、その値を使用（0-2の範囲内である必要がある）

**バリデーション**
- stock_id: 必須、在庫マスタに存在する在庫IDであること
- product_id: 必須、商品マスタに存在する商品IDであること（変更される場合）
- quantity: 必須、0以上の整数
- status: 必須、0（在庫あり）、1（在庫なし）、2（発注済み）のいずれか

**エラーハンドリング**
- 存在チェック: 指定されたstock_idが存在しない場合、エラーを返す
- 商品マスタ存在チェック: 指定されたproduct_idが商品マスタに存在しない場合、エラーを返す
- バリデーションエラー: 必須項目未入力、数値範囲外、ステータス値不正の場合、エラーを返す

#### 在庫削除
**ユースケース**
1. スタッフが削除を行う。

**削除仕様**
- 論理削除を実施（delete_flagをtrueに更新）
- 物理削除は行わず、在庫に関連する情報（注文履歴など）は保持
- 論理削除後は通常の検索では取得されない（delete_flagを明示的に指定した場合のみ取得可能）

**エラーハンドリング**
- 存在チェック: 指定されたstock_idが存在しない場合、エラーを返す
- 既に削除済み: 既に論理削除されている場合もエラーを返す（冪等性のため）

#### 在庫検索
**ユースケース**
1. スタッフが検索を行う。
2. 在庫状況を確認する。

**検索条件**
以下の条件を任意に組み合わせて検索可能（複数条件はAND条件で結合）。

| 項目 | 検索方法 | 説明 |
|------|----------|------|
| product_id | 完全一致 | 商品IDによる完全一致検索 |
| product_name | 部分一致 | 商品名による部分一致検索（LIKE検索）<br>※現時点では未実装（商品マスタとJOINが必要） |
| quantity_min | 以上 | 在庫数量の最小値（以上） |
| quantity_max | 以下 | 在庫数量の最大値（以下） |
| status | 完全一致 | 在庫ステータスによる完全一致検索（0=在庫あり、1=在庫なし、2=発注済み） |
| delete_flag | 完全一致 | 削除フラグによるフィルタ（true/false/null）<br>未指定時は削除済みを除外（falseのみ） |

**検索仕様**
- 複数条件の組み合わせ: AND条件（すべての条件を満たすレコードを取得）
- 範囲検索: quantity_minとquantity_maxを組み合わせて範囲検索が可能
- 削除フラグのデフォルト動作: 
  - 検索条件にdelete_flagが未指定の場合、削除済み（delete_flag=true）のレコードは除外
  - delete_flagを明示的に指定した場合のみ、削除済みレコードも検索対象に含める

**ページング・ソート**
- ページング: 対応（ページ番号、ページサイズを指定可能）
  - ページ番号: 1から開始
  - デフォルトページサイズ: 10件
- ソート: 対応（ソート対象カラム、ソート順を指定可能）
  - ソート対象カラム: stockId, productId, quantity, status
  - ソート順: asc（昇順）/ desc（降順）
  - デフォルトソート: updateDate desc（更新日時降順）

#### 在庫照会（商品ID指定）
**ユースケース**
1. 商品IDを指定して在庫情報を取得する
   - 注文処理時に在庫状況を確認する。

**照会仕様**
- 商品IDを指定して在庫情報を取得
- 商品マスタの存在チェックを実施（存在しない場合はエラー）
- 在庫レコードが存在しない場合はエラー（在庫登録が必要）

**エラーハンドリング**
- 商品マスタ存在チェック: 指定されたproduct_idが商品マスタに存在しない場合、エラーを返す
- 在庫レコード存在チェック: 在庫レコードが存在しない場合、エラーを返す（在庫登録を行うよう案内）

### 在庫一覧
**ユースケース**
ダッシュボード画面に在庫の一覧を表示するために必要な情報を取得する。
